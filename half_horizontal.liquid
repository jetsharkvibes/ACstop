<style>
:root {
  --card-radius: 10px;
  --card-padding: 12px;
  --time-size: 1.8em;
  --badge-radius: 8px;
  --badge-padding: 6px 8px;
  --badge-color: #000;
  --badge-font-size: 10px;
  --dest-size: 1.5em;
  --flex-display: flex;
  --justify-between: space-between;
}
.card-compact { border-radius: var(--card-radius); padding: var(--card-padding); }
.time-compact { line-height: 1.0; font-size: var(--time-size); }
.divider-subtle { border-color: rgba(255,255,255,0.06); }
.badge-row { display: var(--flex-display); gap: 2px; flex-wrap: nowrap; }
.badge-sm { background: white; border-radius: var(--badge-radius); padding: var(--badge-padding); color: var(--badge-color); font-weight: bold; font-size: var(--badge-font-size); white-space: nowrap; }
.card-content { display: var(--flex-display); flex-direction: column; gap: 4px; }
.route-dest-row { display: var(--flex-display); justify-content: var(--justify-between); align-items: center; gap: 4px; }
.dest-text { line-height: .8; font-size: var(--dest-size); data-clamp="2"; }
.grid-full-width { grid-column: 1 / -1; }
</style>

{% comment %} AC Transit API Response Structure {% endcomment %}

{% assign pst_offset = 3600 | times: -8 %}
{% assign now_utc = "now" | date: "%s" %}
{% assign now_pst = now_utc | plus: pst_offset %}

{% assign badge_visibility_raw = trmnl.plugin_settings.custom_fields_values.badge_visibility %}
{% if badge_visibility_raw %}
  {% assign badge_visibility_str = badge_visibility_raw | join: "," %}
{% else %}
  {% assign badge_visibility_str = "delay,wheelchair" %}
{% endif %}

{% assign route_filter = trmnl.plugin_settings.custom_fields_values.route_filter | default: "" %}

{% assign bt_response = bustime-response %}
{% assign predictions = bt_response.prd %}

{% if predictions and predictions.size > 0 %}
  <div class="title_bar">
<img class="image" src="https://usetrmnl.com/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsiZGF0YSI6MTY1MjY4MjksInB1ciI6ImJsb2JfaWQifX0=--7d8a6b9a8829deeea72429db669ea64c191946b8/noun-bus-stop-6545346.png">
    <span class="title">{{ predictions[0].stpnm }}</span>
  </div>
{% endif %}

<div class="layout layout--col gap--small">
  <div class="grid grid--cols-4 gap--small">
    {% assign bus_count = 0 %}

    {% if predictions %}
      {% for pred in predictions %}
        {% if route_filter and route_filter != "" %}
          {% assign filter_string = "," | append: route_filter | append: "," %}
          {% assign search_string = "," | append: pred.rt | append: "," %}
          {% unless filter_string contains search_string %}
            {% continue %}
          {% endunless %}
        {% endif %}

        {% comment %} Limit display to 4 buses after filtering {% endcomment %}
        {% if bus_count >= 4 %}
          {% break %}
        {% endif %}

        <div class="item bg--black card-compact">
          <div class="content card-content">
            <div class="route-dest-row">
              <div class="value value--small text--gray-60">{{ pred.rt }}</div>
              <div class="label label--small text--gray-50 dest-text" data-clamp="2">{{ pred.des }}</div>
            </div>

            <div class="value value--large text--white time-compact">
              {% if pred.prdtm %}
                {{ pred.prdtm | date: "%-I:%M %p" }}
              {% else %}
                --
              {% endif %}
            </div>
            {% unless badge_visibility_str contains "no_badges" %}
              <div class="badge-row">
                {% if badge_visibility_str contains "delay" %}
                  {% if pred.dly == "true" %}
                    <div class="badge-sm">DLY</div>
                  {% endif %}
                {% endif %}
              </div>
            {% endunless %}
          </div>
        </div>
        {% assign bus_count = bus_count | plus: 1 %}
      {% endfor %}
    {% endif %}

    {% if bus_count == 0 %}
      <div class="item bg--black card-compact grid-full-width">
        <div class="content layout--col gap--small">
          <div class="value value--large text--white">⚠️</div>
          <div class="label label--xsmall text--gray-40">No buses</div>
        </div>
      </div>
    {% endif %}
  </div>

</div>